<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Dashboard ‚Äî PawCare</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=Instrument+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --forest:        #1e3a2f;
    --forest-mid:    #2d5040;
    --leaf:          #4a7c59;
    --sage:          #7aaa85;
    --sage-light:    #b8d4bd;
    --mint:          #d4e8d8;
    --cream:         #f8f3ec;
    --parchment:     #ede5d8;
    --sand:          #d6c9b5;
    --amber:         #c8843a;
    --amber-light:   #e8b87a;
    --white:         #fefcf9;
    --text:          #1a1510;
    --text-mid:      #4a3f35;
    --text-light:    #8a7b6e;
    --border:        #e0d5c5;
    --card-bg:       #ffffff;
    --danger:        #b94040;
    --danger-bg:     #fdf0f0;
    --success:       #4a7c59;
    --success-bg:    #e6f4ea;
    --warning:       #d4a017;
    --warning-bg:    #fef9e6;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Instrument Sans', sans-serif;
    background: var(--cream);
    color: var(--text);
    min-height: 100vh;
  }

  /* Navbar */
  .app-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    height: 68px;
    background: var(--forest);
    border-bottom: 1px solid rgba(255,255,255,0.07);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .nav-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: white;
    cursor: pointer;
  }
  .nav-logo-paw {
    width: 32px; height: 32px;
    background: var(--sage);
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem;
  }
  .nav-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .staff-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.76rem;
    color: var(--amber-light);
    background: rgba(232,184,122,0.15);
    border: 1px solid rgba(232,184,122,0.25);
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 500;
  }
  .avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--amber), var(--amber-light));
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; font-weight: 600; color: white;
    border: 2px solid rgba(255,255,255,0.15);
  }
  .btn-logout {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn-logout:hover {
    background: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.3);
  }

  /* Main Layout */
  .main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 40px;
  }

  /* Tabs */
  .tabs-nav {
    display: flex;
    gap: 8px;
    margin-bottom: 32px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
  }
  .tab-button {
    padding: 12px 24px;
    border: none;
    background: transparent;
    color: var(--text-mid);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    font-family: 'Instrument Sans', sans-serif;
  }
  .tab-button:hover {
    color: var(--forest);
    background: var(--cream);
  }
  .tab-button.active {
    color: var(--forest);
    border-bottom-color: var(--forest);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  .page-header {
    margin-bottom: 32px;
  }
  .page-title {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--forest);
    margin-bottom: 8px;
  }
  .page-subtitle {
    color: var(--text-light);
    font-size: 0.9rem;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 32px;
  }
  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(30,58,47,0.1);
  }
  .stat-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 16px;
  }
  .stat-icon-pending { background: #fef9e6; }
  .stat-icon-confirmed { background: #e6f4ea; }
  .stat-icon-today { background: #e8f3fb; }
  .stat-icon-total { background: var(--parchment); }
  .stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
  }
  .stat-value {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--forest);
  }
  .stat-change {
    font-size: 0.75rem;
    color: var(--success);
    margin-top: 4px;
  }

  /* Calendar */
  .calendar-section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    margin-bottom: 32px;
  }
  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .calendar-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--forest);
  }
  .calendar-nav {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .calendar-month {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    min-width: 150px;
    text-align: center;
  }
  .calendar-btn {
    width: 32px; height: 32px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--cream);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  .calendar-btn:hover {
    background: var(--forest);
    color: white;
    border-color: var(--forest);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }
  .calendar-day-header {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-light);
    padding: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .calendar-day {
    aspect-ratio: 1;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: var(--cream);
    display: flex;
    flex-direction: column;
    min-height: 80px;
  }
  .calendar-day:hover {
    border-color: var(--sage);
    background: white;
  }
  .calendar-day.other-month {
    opacity: 0.3;
  }
  .calendar-day.today {
    border-color: var(--amber);
    background: #fef5e7;
    font-weight: 700;
  }
  .calendar-day.today .calendar-day-number {
    color: var(--amber);
  }
  .calendar-day.has-appointments {
    background: white;
    border-color: var(--sage);
  }
  .calendar-day-number {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 4px;
    flex-shrink: 0;
  }
  .calendar-day-appointments {
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow-y: auto;
    flex: 1;
  }
  .calendar-appt-item {
    font-size: 0.65rem;
    padding: 2px 4px;
    border-radius: 4px;
    background: var(--forest);
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .calendar-appt-item.pending {
    background: var(--warning);
  }
  .calendar-appt-item.confirmed {
    background: var(--success);
  }
  .calendar-day-dots {
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .calendar-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--forest);
  }
  .calendar-appointment-item {
    font-size: 0.65rem;
    padding: 2px 4px;
    margin: 2px 0;
    border-radius: 4px;
    background: var(--success-bg);
    color: var(--success);
    border-left: 2px solid var(--success);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
  }
  .calendar-appointment-item:hover {
    background: var(--success);
    color: white;
  }
  .calendar-appointment-item.pending {
    background: var(--warning-bg);
    color: var(--warning);
    border-left-color: var(--warning);
  }
  .calendar-appointment-item.pending:hover {
    background: var(--warning);
    color: white;
  }
  .calendar-appointment-more {
    font-size: 0.6rem;
    color: var(--text-light);
    text-align: center;
    margin-top: 2px;
    font-weight: 600;
  }

  /* Appointments List */
  .appointments-section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
  }
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--forest);
  }
  .filter-tabs {
    display: flex;
    gap: 8px;
  }
  .filter-tab {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-mid);
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-tab:hover {
    border-color: var(--sage);
    color: var(--forest);
  }
  .filter-tab.active {
    background: var(--forest);
    color: white;
    border-color: var(--forest);
  }

  .appointments-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .appointment-card {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 20px;
    align-items: center;
    padding: 16px 20px;
    border: 1px solid var(--border);
    border-radius: 12px;
    transition: all 0.2s;
    cursor: pointer;
  }
  .appointment-card:hover {
    border-color: var(--sage);
    box-shadow: 0 4px 12px rgba(30,58,47,0.08);
  }
  .appt-time {
    text-align: center;
    min-width: 70px;
  }
  .appt-time-hour {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--forest);
  }
  .appt-time-date {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 2px;
  }
  .appt-info {
    flex: 1;
  }
  .appt-pet {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 4px;
  }
  .appt-owner {
    font-size: 0.8rem;
    color: var(--text-mid);
    margin-bottom: 4px;
  }
  .appt-service {
    font-size: 0.75rem;
    color: var(--text-light);
  }
  .appt-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .status-pending { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning); }
  .status-confirmed { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }
  .status-completed { background: #e8f3fb; color: #2a6280; border: 1px solid #b8d5ea; }
  .status-cancelled { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger); }

  .appt-actions {
    display: flex;
    gap: 8px;
  }
  .btn-action {
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-confirm {
    background: var(--success-bg);
    color: var(--success);
    border-color: var(--success);
  }
  .btn-confirm:hover {
    background: var(--success);
    color: white;
  }
  .btn-complete {
    background: #e8f3fb;
    color: #2a6280;
    border-color: #2a6280;
  }
  .btn-complete:hover {
    background: #2a6280;
    color: white;
  }
  .btn-cancel {
    background: transparent;
    color: var(--danger);
    border-color: var(--danger);
  }
  .btn-cancel:hover {
    background: var(--danger-bg);
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
  }
  .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  .empty-text {
    font-size: 0.9rem;
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .main-container {
      padding: 20px;
    }
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .calendar-grid {
      gap: 4px;
    }
    .appointment-card {
      grid-template-columns: 1fr;
      gap: 12px;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30, 58, 47, 0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  .modal-overlay.open {
    opacity: 1;
    visibility: visible;
  }
  .modal {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(30, 58, 47, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.9);
    transition: transform 0.3s ease;
  }
  .modal-overlay.open .modal {
    transform: scale(1);
  }
  .modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 28px 32px 20px;
    border-bottom: 1px solid var(--border);
  }
  .modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--forest);
    margin-bottom: 4px;
  }
  .modal-sub {
    font-size: 0.85rem;
    color: var(--text-light);
  }
  .modal-close {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--cream);
    color: var(--text-mid);
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .modal-close:hover {
    background: var(--danger-bg);
    color: var(--danger);
    border-color: var(--danger);
  }
  .modal-body {
    padding: 24px 32px;
  }
  .modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 32px 28px;
    border-top: 1px solid var(--border);
  }
  .modal-footer .btn {
    flex: 1;
  }
  .btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    font-family: 'Instrument Sans', sans-serif;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .btn-outline {
    background: transparent;
    border-color: var(--border);
    color: var(--text-mid);
  }
  .btn-outline:hover {
    border-color: var(--forest);
    color: var(--forest);
  }
  .btn-danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }
  .btn-danger:hover {
    background: #a03636;
  }

</style>
</head>
<body>

<!-- Navbar -->
<nav class="app-nav">
  <div class="nav-logo" onclick="window.location.href='/landing.html'">
    <div class="nav-logo-paw">üêæ</div>
    <span>PawCare</span>
  </div>
  <div class="nav-user">
    <div class="staff-badge">
      <span>üë®‚Äç‚öïÔ∏è</span>
      <span>Staff Dashboard</span>
    </div>
    <div class="avatar" id="user-avatar">AD</div>
    <button class="btn-logout" onclick="openModal('logout-modal')">
      <span>üö™</span>
      <span>Logout</span>
    </button>
  </div>
</nav>

<!-- Main Content -->
<div class="main-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Staff Dashboard</h1>
    <p class="page-subtitle" id="current-date">Loading...</p>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-nav">
    <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-button" onclick="switchTab('appointments')">All Appointments</button>
    <button class="tab-button" onclick="switchTab('settings')">Settings</button>
  </div>

  <!-- Dashboard Tab -->
  <div id="dashboard-tab" class="tab-content active">
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon stat-icon-pending">‚è≥</div>
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="stat-pending">0</div>
        <div class="stat-change">Awaiting confirmation</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon stat-icon-confirmed">‚úì</div>
        <div class="stat-label">Confirmed</div>
        <div class="stat-value" id="stat-confirmed">0</div>
        <div class="stat-change">Ready for today</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon stat-icon-today">üìÖ</div>
        <div class="stat-label">Today</div>
        <div class="stat-value" id="stat-today">0</div>
        <div class="stat-change">Scheduled appointments</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon stat-icon-total">üìä</div>
        <div class="stat-label">Total</div>
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-change">All appointments</div>
      </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-section">
      <div class="calendar-header">
        <h2 class="calendar-title">Appointment Calendar</h2>
        <div class="calendar-nav">
          <button class="calendar-btn" onclick="previousMonth()">‚Üê</button>
          <div class="calendar-month" id="calendar-month">February 2026</div>
          <button class="calendar-btn" onclick="nextMonth()">‚Üí</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendar-grid">
        <!-- Calendar will be generated here -->
      </div>
    </div>
  </div>

  <!-- Appointments Tab -->
  <div id="appointments-tab" class="tab-content">
    <div class="appointments-section">
      <div class="section-header">
        <h2 class="section-title">All Appointments</h2>
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterAppointments('all')">All</button>
          <button class="filter-tab" onclick="filterAppointments('pending')">Pending</button>
          <button class="filter-tab" onclick="filterAppointments('confirmed')">Confirmed</button>
          <button class="filter-tab" onclick="filterAppointments('today')">Today</button>
          <button class="filter-tab" onclick="filterAppointments('completed')">Completed</button>
        </div>
      </div>
      <div class="appointments-list" id="appointments-list">
        <!-- Appointments will be loaded here -->
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <div class="empty-text">Loading appointments...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="settings-tab" class="tab-content">
    <div class="appointments-section">
      <div class="section-header">
        <h2 class="section-title">Clinic Settings</h2>
      </div>
      <div style="padding: 40px; text-align: center; color: var(--text-light);">
        <div style="font-size: 3rem; margin-bottom: 16px;">‚öôÔ∏è</div>
        <div style="font-size: 1.1rem; margin-bottom: 8px;">Settings Coming Soon</div>
        <div style="font-size: 0.9rem;">Clinic hours management will be available here</div>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal-overlay" id="logout-modal">
  <div class="modal" style="max-width: 420px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Confirm Logout</div>
        <div class="modal-sub">Are you sure you want to logout?</div>
      </div>
      <button class="modal-close" onclick="closeModal('logout-modal')">‚úï</button>
    </div>
    <div class="modal-body" style="padding: 24px 32px;">
      <div style="text-align: center; padding: 20px 0;">
        <div style="font-size: 3rem; margin-bottom: 12px;">üëã</div>
        <p style="color: var(--text-light); font-size: 0.95rem; line-height: 1.6;">
          You'll be redirected to the login page.
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('logout-modal')">Cancel</button>
      <button class="btn btn-danger" onclick="confirmLogout()">Yes, Logout</button>
    </div>
  </div>
</div>

<script>
const API_BASE_URL = 'http://localhost:8000';
let currentUser = null;
let allAppointments = [];
let allPets = [];
let allUsers = [];
let currentMonth = new Date();
let currentFilter = 'all';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  updateCurrentDate();
});

// Check authentication
async function checkAuth() {
  const token = localStorage.getItem('access_token');
  
  if (!token) {
    window.location.href = '/auth.html';
    return;
  }

  try {
    const response = await fetch(`${API_BASE_URL}/api/v1/users/profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      currentUser = await response.json();
      
      // Check if user is admin
      if (currentUser.role !== 'admin') {
        showToast('Access denied. This dashboard is for staff only.', '‚ùå');
        setTimeout(() => window.location.href = '/app.html', 2000);
        return;
      }
      
      updateUserUI();
      loadAllData();
    } else {
      localStorage.removeItem('access_token');
      window.location.href = '/auth.html';
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    showToast('Connection error. Please check if backend is running.', '‚ùå');
  }
}

// Update user UI
function updateUserUI() {
  if (!currentUser) return;
  
  const initials = currentUser.full_name
    .split(' ')
    .map(n => n[0])
    .join('')
    .toUpperCase()
    .substring(0, 2);
  
  document.getElementById('user-avatar').textContent = initials;
}

// Update current date
function updateCurrentDate() {
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const dateStr = new Date().toLocaleDateString('en-US', options);
  document.getElementById('current-date').textContent = dateStr;
}

// Load all data (appointments, pets, users) in parallel
async function loadAllData() {
  const token = localStorage.getItem('access_token');
  
  try {
    const [appointmentsRes, petsRes, usersRes] = await Promise.all([
      fetch(`${API_BASE_URL}/api/v1/appointments`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }),
      fetch(`${API_BASE_URL}/api/v1/pets`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }),
      fetch(`${API_BASE_URL}/api/v1/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
    ]);

    if (appointmentsRes.ok && petsRes.ok && usersRes.ok) {
      allAppointments = await appointmentsRes.json();
      allPets = await petsRes.json();
      allUsers = await usersRes.json();
      
      // Enrich appointments with pet and owner details
      enrichAppointments();
      
      updateStats();
      renderCalendar();
      renderAppointments();
    } else {
      console.error('Failed to load data');
      showToast('Failed to load dashboard data', '‚ùå');
    }
  } catch (error) {
    console.error('Error loading data:', error);
    showToast('Error loading dashboard data', '‚ùå');
  }
}

// Enrich appointments with pet and owner details
function enrichAppointments() {
  // Create lookup maps for faster access
  const petMap = {};
  allPets.forEach(pet => {
    petMap[pet.id] = pet;
  });
  
  const userMap = {};
  allUsers.forEach(user => {
    userMap[user.id] = user;
  });
  
  // Enrich each appointment
  allAppointments = allAppointments.map(appt => {
    const pet = petMap[appt.pet_id];
    const owner = pet ? userMap[pet.user_id] : null;
    
    return {
      ...appt,
      pet_name: pet?.name || 'Unknown Pet',
      pet_species: pet?.species || 'unknown',
      pet_breed: pet?.breed || '',
      owner_name: owner?.full_name || 'Unknown Owner',
      owner_email: owner?.email || '',
      owner_phone: owner?.phone || ''
    };
  });
}

// Update stats
function updateStats() {
  const today = new Date().toISOString().split('T')[0];
  
  const pending = allAppointments.filter(a => a.status === 'pending').length;
  const confirmed = allAppointments.filter(a => a.status === 'confirmed').length;
  const todayAppts = allAppointments.filter(a => 
    a.start_time.startsWith(today)
  ).length;
  
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-confirmed').textContent = confirmed;
  document.getElementById('stat-today').textContent = todayAppts;
  document.getElementById('stat-total').textContent = allAppointments.length;
}

// Render calendar
function renderCalendar() {
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  
  // Update month display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  
  // Day headers
  const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayHeaders.forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    header.textContent = day;
    grid.appendChild(header);
  });
  
  // Previous month days
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = daysInPrevMonth - i;
    const cell = createDayCell(day, true);
    grid.appendChild(cell);
  }
  
  // Current month days
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    const dayAppointments = allAppointments.filter(a => 
      a.start_time.startsWith(dateStr)
    );
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (date.toDateString() === today.toDateString()) {
      cell.classList.add('today');
    }
    
    if (dayAppointments.length > 0) {
      cell.classList.add('has-appointments');
      cell.title = `${dayAppointments.length} appointment${dayAppointments.length > 1 ? 's' : ''} on this day`;
    }
    
    // Sort appointments by time
    const sortedAppointments = dayAppointments.sort((a, b) => 
      new Date(a.start_time) - new Date(b.start_time)
    );
    
    // Show up to 3 appointments with details
    const appointmentsToShow = sortedAppointments.slice(0, 3);
    const remainingCount = dayAppointments.length - 3;
    
    const appointmentItems = appointmentsToShow.map(appt => {
      const time = new Date(appt.start_time).toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
      const statusClass = appt.status === 'pending' ? 'pending' : '';
      return `<div class="calendar-appointment-item ${statusClass}" title="${appt.pet_name} - ${appt.service_type}">${time} ${appt.pet_name}</div>`;
    }).join('');
    
    cell.innerHTML = `
      <div class="calendar-day-number">${day}</div>
      <div class="calendar-day-appointments">
        ${appointmentItems}
        ${remainingCount > 0 ? `<div class="calendar-appointment-more">+${remainingCount} more</div>` : ''}
      </div>
    `;
    
    cell.onclick = () => filterByDate(dateStr);
    grid.appendChild(cell);
  }
  
  // Next month days
  const remainingCells = 42 - (firstDay + daysInMonth);
  for (let day = 1; day <= remainingCells; day++) {
    const cell = createDayCell(day, true);
    grid.appendChild(cell);
  }
}

function createDayCell(day, otherMonth) {
  const cell = document.createElement('div');
  cell.className = 'calendar-day';
  if (otherMonth) cell.classList.add('other-month');
  cell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
  return cell;
}

function previousMonth() {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
  renderCalendar();
}

// Switch between tabs
function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // Add active class to clicked button
  event.target.classList.add('active');
}

// Render appointments with full details
function renderAppointments() {
  const container = document.getElementById('appointments-list');
  
  let filtered = allAppointments;
  
  if (currentFilter === 'all') {
    // Exclude completed and cancelled from "All" view
    filtered = allAppointments.filter(a => a.status !== 'completed' && a.status !== 'cancelled');
  } else if (currentFilter === 'pending') {
    filtered = allAppointments.filter(a => a.status === 'pending');
  } else if (currentFilter === 'confirmed') {
    filtered = allAppointments.filter(a => a.status === 'confirmed');
  } else if (currentFilter === 'completed') {
    filtered = allAppointments.filter(a => a.status === 'completed');
  } else if (currentFilter === 'today') {
    const today = new Date().toISOString().split('T')[0];
    // Exclude completed from today view
    filtered = allAppointments.filter(a => 
      a.start_time.startsWith(today) && a.status !== 'completed' && a.status !== 'cancelled'
    );
  } else if (currentFilter.startsWith('date-')) {
    const dateStr = currentFilter.replace('date-', '');
    filtered = allAppointments.filter(a => a.start_time.startsWith(dateStr));
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-text">No appointments found</div>
      </div>
    `;
    return;
  }
  
  // Sort by start time
  filtered.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
  
  container.innerHTML = filtered.map(appt => {
    const startTime = new Date(appt.start_time);
    const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const dateStr = startTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    // Get species emoji
    const speciesEmoji = appt.pet_species === 'dog' ? 'üê∂' : 
                        appt.pet_species === 'cat' ? 'üê±' : 'üêæ';
    
    return `
      <div class="appointment-card">
        <div class="appt-time">
          <div class="appt-time-hour">${timeStr}</div>
          <div class="appt-time-date">${dateStr}</div>
        </div>
        <div class="appt-info">
          <div class="appt-pet">${speciesEmoji} ${appt.pet_name}${appt.pet_breed ? ` (${appt.pet_breed})` : ''}</div>
          <div class="appt-owner">Owner: ${appt.owner_name}</div>
          <div class="appt-service">${appt.service_type}${appt.owner_phone ? ` ‚Ä¢ ${appt.owner_phone}` : ''}</div>
        </div>
        <div class="appt-status status-${appt.status}">${appt.status}</div>
        <div class="appt-actions">
          ${appt.status === 'pending' ? `
            <button class="btn-action btn-confirm" onclick="confirmAppointment('${appt.id}')">Confirm</button>
          ` : ''}
          ${appt.status === 'confirmed' ? `
            <button class="btn-action btn-complete" onclick="completeAppointment('${appt.id}')">Complete</button>
          ` : ''}
          ${appt.status !== 'cancelled' && appt.status !== 'completed' ? `
            <button class="btn-action btn-cancel" onclick="cancelAppointment('${appt.id}')">Cancel</button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Filter appointments
function filterAppointments(filter) {
  currentFilter = filter;
  
  // Update active tab
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderAppointments();
}

// Filter by date
function filterByDate(dateStr) {
  // Switch to appointments tab
  switchTabProgrammatically('appointments');
  
  // Set filter to show appointments for this date
  currentFilter = 'date-' + dateStr;
  
  // Update filter tabs to show none active
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Render appointments for this date
  renderAppointments();
}

// Switch tab programmatically (without event)
function switchTabProgrammatically(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // Add active class to corresponding button
  document.querySelectorAll('.tab-button').forEach(btn => {
    if (btn.textContent.toLowerCase().includes(tabName)) {
      btn.classList.add('active');
    }
  });
}

// Confirm appointment
async function confirmAppointment(id) {
  const token = localStorage.getItem('access_token');
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/v1/appointments/${id}/status`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: 'confirmed' })
    });

    if (response.ok) {
      showToast('Appointment confirmed!', '‚úì');
      loadAllData();
    } else {
      const error = await response.json();
      showToast(error.detail || 'Failed to confirm appointment', '‚ùå');
    }
  } catch (error) {
    console.error('Error confirming appointment:', error);
    showToast('Error confirming appointment', '‚ùå');
  }
}

// Complete appointment
async function completeAppointment(id) {
  const token = localStorage.getItem('access_token');
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/v1/appointments/${id}/status`, {
      method: 'PATCH',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: 'completed' })
    });

    if (response.ok) {
      showToast('Appointment marked as completed!', '‚úì');
      loadAllData();
    } else {
      const error = await response.json();
      showToast(error.detail || 'Failed to complete appointment', '‚ùå');
    }
  } catch (error) {
    console.error('Error completing appointment:', error);
    showToast('Error completing appointment', '‚ùå');
  }
}

// Cancel appointment
async function cancelAppointment(id) {
  const token = localStorage.getItem('access_token');
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/v1/appointments/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      showToast('Appointment cancelled', '‚úì');
      loadAllData();
    } else {
      const error = await response.json();
      showToast(error.detail || 'Failed to cancel appointment', '‚ùå');
    }
  } catch (error) {
    console.error('Error cancelling appointment:', error);
    showToast('Error cancelling appointment', '‚ùå');
  }
}

// Modal functions
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-overlay')) {
    closeModal(e.target.id);
  }
});

// Logout - called from modal
async function confirmLogout() {
  closeModal('logout-modal');
  
  const token = localStorage.getItem('access_token');
  
  if (token) {
    try {
      await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    } catch (error) {
      console.error('Logout error:', error);
    }
  }
  
  localStorage.removeItem('access_token');
  window.location.href = '/auth.html';
}

// Toast notification system
function showToast(message, icon = '‚úì') {
  // Remove existing toast if any
  const existingToast = document.querySelector('.toast-notification');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <span class="toast-icon">${icon}</span>
    <span class="toast-message">${message}</span>
  `;
  
  // Add styles if not already present
  if (!document.querySelector('#toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
      .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--forest);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 24px rgba(30,58,47,0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      }
      .toast-icon {
        font-size: 1.2rem;
      }
      .toast-message {
        font-size: 0.9rem;
        font-weight: 500;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(toast);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>

</body>
</html>
